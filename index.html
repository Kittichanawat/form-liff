<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ¬∑ Codelabs</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Icons / UI libs -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="global.css">

</head>
<body>
  <main class="page-shell">
    <!-- Header / Brand -->
    <header class="d-flex justify-content-between align-items-center mb-4">
      <div class="brand-badge">
        <i class="fa-solid fa-atom"></i>
        <span>Codelabs</span>
      </div>
      <small class="text-muted">Secure Onboarding</small>
    </header>

    <!-- Content Card -->
    <section class="glass-card card-pad animate-in">
      <div class="mb-3">
        <h1 class="hero-title mb-1"><i class="fa-solid fa-id-card me-2"></i>‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
        <p class="hero-sub">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (OTP)</p>
      </div>

      <form id="form" novalidate>
        <input type="hidden" id="userId" />
        <input type="hidden" id="displayName" />

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="flname" class="form-label form-section-title">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
            <div class="field">
              <i class="fa-solid fa-user input-icon"></i>
              <input type="text" id="flname" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏ô‡∏±‡∏ô‡∏ï‡πå ‡πÉ‡∏à‡∏î‡∏µ" required />
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label for="nname" class="form-label form-section-title">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
            <div class="field">
              <i class="fa-solid fa-user-tag input-icon"></i>
              <input type="text" id="nname" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ö‡∏™‡∏ó‡πå" required />
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label for="dob" class="form-label form-section-title">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</label>
            <div class="field">
              <i class="fa-solid fa-calendar-days input-icon"></i>
              <input type="date" id="dob" class="form-control" required />
            </div>
          </div>

          <!-- ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å -->
<div class="col-12 col-md-6">
  <label for="department" class="form-label form-section-title">‡πÅ‡∏ú‡∏ô‡∏Å</label>
  <div class="field">
    <i class="fa-solid fa-building input-icon"></i>
    <select id="department" class="form-select" required>
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
    </select>
  </div>
</div>

<!-- ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏£‡∏Å) -->
<div class="col-12 col-md-6" id="position-wrapper" style="display:none;">
  <label for="position" class="form-label form-section-title">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
  <div class="field">
    <i class="fa-solid fa-briefcase input-icon"></i>
    <select id="position" class="form-select" required>
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
    </select>
  </div>
</div>


          <div class="col-12 col-md-6">
            <label for="email" class="form-label form-section-title">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <div class="field">
              <i class="fa-solid fa-envelope input-icon"></i>
              <input type="email" id="email" class="form-control" placeholder="name@company.com" required />
            </div>
          </div>

          <div class="col-12 col-md-6">
            <label for="phone" class="form-label form-section-title">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <div class="field">
              <i class="fa-solid fa-phone input-icon"></i>
              <input type="tel" id="phone" class="form-control" inputmode="numeric" pattern="[0-9]{10}" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 0812345678" required />
            </div>
            <div class="form-text">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å</div>
          </div>
        </div>

        <div class="mt-4 d-grid">
          <button type="submit" id="submitBtn" class="btn btn-gradient">
            <i class="fa-solid fa-paper-plane me-2"></i>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            <span class="spinner-border spinner-border-sm ms-2 d-none" id="submitSpinner" role="status" aria-hidden="true"></span>
          </button>
        </div>

        <div class="mt-3 divider"><span><i class="fa-regular fa-circle-check me-1"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span></div>
      </form>
    </section>
  </main>

  <!-- OTP Modal -->
  <div class="modal fade" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 glass-card">
        <div class="modal-header" style="background:linear-gradient(90deg, var(--brand-1), var(--brand-2)); color:#fff;">
          <h5 class="modal-title" id="otpModalLabel"><i class="fa-solid fa-key me-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
        </div>
        <div class="modal-body">
          <p id="otp-info" class="mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà <strong id="otp-phone"></strong></p>
          <div class="mb-3">
            <label for="inputOtp" class="form-label">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP 6 ‡∏´‡∏•‡∏±‡∏Å</label>
            <input type="text" class="form-control" id="inputOtp" maxlength="6" placeholder="X X X X X X" pattern="\d{6}">
            <div class="form-text">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</div>
          </div>
          <div id="otp-error" class="text-danger small d-none">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
        </div>
        <div class="modal-footer">
          <button type="button" id="resendOtpBtn" class="btn btn-outline-secondary">
            <i class="fa-solid fa-rotate me-1"></i>‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
          </button>
          <button type="button" id="verifyOtpBtn" class="btn btn-primary">
            <i class="fa-solid fa-shield-halved me-1"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://ceya6a6a4tqxef5wskbfjx4yr40cxrgo.lambda-url.ap-southeast-2.on.aws/ "; // üëâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô API Gateway ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    let depMap = {};
    let lastSentData = null;
    let otpModalInstance = null;
    let liffAccessToken = null;

    // ===== Init LIFF =====
    async function initLIFF() {
      await liff.init({ liffId: "2007772610-2rjPV8NG" });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      document.getElementById("userId").value = profile.userId;
      document.getElementById("displayName").value = profile.displayName;
      liffAccessToken = liff.getAccessToken(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Lambda
    }

    // ===== Helper: API fetch ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö token =====
    async function apiFetch(path, options = {}) {
      const headers = options.headers || {};
      headers["Authorization"] = `Bearer ${liffAccessToken}`;
      headers["Content-Type"] = "application/json";
      return fetch(`${API_BASE}${path}`, { ...options, headers });
    }

    // ===== ‡πÇ‡∏´‡∏•‡∏î department =====
    async function loadDepartments() {
      const res = await apiFetch("/departments");
      const data = await res.json();
      depMap = {};
      data.forEach(item => {
        const dep = item;
        depMap[dep.dep_id] = dep;
      });
      const depSelect = document.getElementById("department");
      depSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
      Object.values(depMap).forEach(dep => {
        const opt = document.createElement("option");
        opt.value = dep.dep_id;
        opt.textContent = dep.dep_name;
        depSelect.appendChild(opt);
      });
    }

    document.getElementById("department").addEventListener("change", e => {
      const depId = e.target.value;
      const posSelect = document.getElementById("position");
      posSelect.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
      if (depId && depMap[depId]) {
        depMap[depId].positions.forEach(pos => {
          const opt = document.createElement("option");
          opt.value = pos.p_id;
          opt.textContent = pos.p_name;
          posSelect.appendChild(opt);
        });
        document.getElementById("position-wrapper").style.display = "block";
      } else {
        document.getElementById("position-wrapper").style.display = "none";
      }
    });

    // ===== ‡∏ü‡∏≠‡∏£‡πå‡∏° submit =====
    document.getElementById("form").addEventListener("submit", async e => {
      e.preventDefault();
      const phone = document.getElementById("phone").value.trim();
      if (!/^\d{10}$/.test(phone)) {
        Swal.fire("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å", "warning");
        return;
      }
      const data = {
        userId: document.getElementById("userId").value,
        name: document.getElementById("flname").value,
        nickname: document.getElementById("nname").value,
        dob: document.getElementById("dob").value,
        position: document.getElementById("position").value,
        email: document.getElementById("email").value,
        phone: phone
      };
      lastSentData = data;
      const res = await apiFetch("/send-otp", { method: "POST", body: JSON.stringify(data) });
      const result = await res.json();
      if (result.success) {
        document.getElementById("otp-phone").textContent = phone;
        document.getElementById("inputOtp").value = "";
        document.getElementById("otp-error").classList.add("d-none");
        otpModalInstance.show();
      } else {
        Swal.fire("‡∏™‡πà‡∏á OTP ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", result.message, "error");
      }
    });

    // ===== Verify OTP =====
    async function verifyOtp() {
      const phone = document.getElementById("phone").value;
      const otp = document.getElementById("inputOtp").value;
      const res = await apiFetch("/verify-otp", { method: "POST", body: JSON.stringify({ phone, otp }) });
      const result = await res.json();
      if (!result.verified) {
        document.getElementById("otp-error").textContent = "OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏";
        document.getElementById("otp-error").classList.remove("d-none");
        return;
      }
      await apiFetch("/save-form", { method: "POST", body: JSON.stringify(lastSentData) });
      otpModalInstance.hide();
      Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "success");
    }

    // ===== Resend OTP =====
    async function resendOtp() {
      await apiFetch("/send-otp", { method: "POST", body: JSON.stringify(lastSentData) });
      Swal.fire("‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß", `OTP ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${lastSentData.phone}`, "success");
    }

    // ===== Init =====
    document.addEventListener("DOMContentLoaded", () => {
      otpModalInstance = new bootstrap.Modal(document.getElementById("otpModal"), { backdrop: "static", keyboard: false });
      document.getElementById("verifyOtpBtn").addEventListener("click", verifyOtp);
      document.getElementById("resendOtpBtn").addEventListener("click", resendOtp);
      initLIFF().then(loadDepartments);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
</html>
